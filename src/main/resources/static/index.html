<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <title>Demo</title>
    <meta name="description" content=""/>
    <meta name="viewport" content="width=device-width"/>
    <base href="/"/>
    <link rel="stylesheet" type="text/css" href="/webjars/bootstrap/5.1.3/css/bootstrap.min.css"/>
    <script type="text/javascript" src="/webjars/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="/webjars/bootstrap/5.1.3/js/bootstrap.min.js"></script>
</head>

<body>
<div class="container-fluid">

    <div class="d-block justify-content-center w-75 border border-dark p-5 m-5">
        <div class="authenticated" style="display:none">
            Logged in as: <span id="user"></span>
            <img id="avatar" src="" alt="">
            <div>
                <button onClick="logout()" class="btn btn-warning">Logout</button>
            </div>
        </div>

        <div>
            <a href="/h2-console">h2-console</a>
        </div>

        <div>
            <!--    <div class="container unauthenticated">-->
            <!--        With GitHub: <a href="/oauth2/authorization/github">click here</a>-->
            <!--    </div>-->
            <!--    <div class="container unauthenticated">-->
            <!--        With Google: <a href="/oauth2/authorization/google">click here</a>-->
            <!--    </div>-->
            <!--    <div class="container unauthenticated">-->
            <!--        With Kakao: <a href="/oauth2/authorization/kakao">click here</a>-->
            <!--&lt;!&ndash;        With Kakao: <button onclick="KakaoLogin()" class="d-inline page-link">click here</button>&ndash;&gt;-->
            <!--    </div>-->
            <button class="btn btn-secondary" onclick="adminLogin()">Admin Login</button>
            <button class="btn btn-primary">User Login</button>
        </div>

        <div>
            <button onclick="userList()">User List</button>
            <button onclick="getUser()">My Info</button>
        </div>
    </div>


    <script type="text/javascript" src="/webjars/js-cookie/3.0.1/dist/js.cookie.js"></script>
    <script type="text/javascript">
        let accessToken;
        // $.ajaxSetup({
        //         beforeSend: function (xhr, settings) {
        //             if (settings.type === 'POST' || settings.type === 'PUT'
        //                 || settings.type === 'DELETE') {
        //                 if (!(/^http:.*/.test(settings.url) || /^https:.*/
        //                     .test(settings.url))) {
        //                     xhr.setRequestHeader("X-XSRF-TOKEN", Cookies.get('XSRF-TOKEN'));
        //                 }
        //             }
        //         }
        //     });

        // $.get("/user", function (data) {
        //     $("#user").html(data.name);
        //     $(".unauthenticated").hide();
        //     $(".authenticated").show();
        // });

        console.log(accessToken);

        if (accessToken !== undefined) {
            $.ajax({
                type: 'GET',
                url: "/api/user",
                beforeSend: function (xhr) {
                    console.log(xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken));
                },
                success: function (data) {

                    if (data === null || data === "") {
                        console.log("Not Logged in");
                        return;
                    }
                    console.log(data);
                    $('#user').html(data.username);
                    // $("#avatar").attr("src", data.picture);
                    $('.unauthenticated').hide();
                    $('.authenticated').show();
                }
            });
        }

        const getUser = function () {
            $.ajax({
                type: 'GET',
                url: "/api/user",
                beforeSend: function (xhr) {
                    console.log(accessToken);
                    console.log(xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken));
                },
                success: function (data) {

                    if (data === null || data === "") {
                        console.log("Not Logged in");
                        return;
                    }
                    console.log(data);
                    $('#user').html(data.username);
                    // $("#avatar").attr("src", data.picture);
                    $('.unauthenticated').hide();
                    $('.authenticated').show();
                }
            });
        }

        const KakaoLogin = function () {
            // const xhr = new XMLHttpRequest();
            // const url = 'http://localhost:8080/oauth2/authorization/kakao';
            //
            // if (xhr) {
            //     xhr.open('GET', url, true);
            //     xhr.withCredentials = true;
            //     xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
            //     if(xhr.readyState === XMLHttpRequest.DONE) {
            //         const status = xhr.status;
            //         console.log(status);
            //         if (status === 0 || (status >= 200 && status < 400)) {
            //             // The request has been completed successfully
            //             console.log(xhr.responseText);
            //         } else {
            //             // Oh no! There has been an error with the request!
            //         }
            //     }
            //     xhr.send();
            // }
            $.ajax({
                type: 'GET',
                url: 'http://localhost:8080/oauth2/authorization/kakao',
                crossDomain: true,
                dataType: "jsonp",
                format: "json",
                error: function (data) {
                    if (data === null || data === "") {
                        console.log("Not Logged in");
                    }
                },
                success: function (data) {
                    console.log(data);
                    // $("#user").html(data.nickname);
                    // $("#avatar").attr("src", data.picture);
                    // $(".unauthenticated").hide();
                    // $(".authenticated").show();
                }
            });
        }

        const adminLogin = function () {
            $.ajax({
                type: 'POST',
                url: "/api/authenticate",
                contentType: "application/json; charset=utf-8",
                dataType: 'JSON',
                data: JSON.stringify({
                    username: "admin",
                    password: "admin"
                }),
                success(data, status, xhr) {
                    // console.log(data);
                    // $("#result").html(data);
                    // console.log(status);
                    // console.log(xhr);
                    console.log("Access Token: " + data.accessToken);
                    accessToken = data.accessToken;
                    // xhr.setRequestHeader('Authorization', 'Bearer ' + data.accessToken);
                    console.log(xhr.getResponseHeader('Authorization'));
                    getUser();
                    // window.location.reload();
                }
            });
        }

        const userList = function () {
            $.ajax({
                type: 'GET',
                url: "/api/user/list",
                contentType: "application/json; charset=utf-8",
                dataType: 'JSON',
                beforeSend: function (xhr) {
                    console.log(xhr.getResponseHeader('Authorization'));
                }
            })
        }

        const logout = function () {
            $.ajax({
                type: 'GET',
                url: "/api/logout",
                success: function (data, status) {
                    console.log(status);
                    $("#user").html('');
                    $(".unauthenticated").show();
                    $(".authenticated").hide();
                }
            });
        };
    </script>
</div>
</body>

</html>